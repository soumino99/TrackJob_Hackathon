{% extends "base.html" %} {% block title %}マイページ - UniChat{% endblock %} {%
block content %}
<div class="timeline-container">
  <h2>{{ current_user.username }} のマイページ</h2>

  <div class="mb-3">
    <a href="{{ url_for('post') }}" class="btn btn-tweet">新規投稿</a>
  </div>

  {% if posts %} {% for post in posts %}
  <div class="post-card">
    <div class="post-header">
      <span class="username">{{ current_user.username }}</span>
      <span class="timestamp">{{ post.timestamp|jst }}</span>
      <span
        class="channel-label {{ post.channel }}"
        data-channel="{{ post.channel }}"
      >
        {{ post.channel|channel_jp }}
      </span>
      {% if post.author == current_user %}
      <form
        action="{{ url_for('delete_post', post_id=post.id) }}"
        method="post"
        class="ms-auto"
      >
        <button
          type="submit"
          class="btn btn-sm btn-outline-danger"
          title="削除"
        >
          🗑️
        </button>
      </form>
      {% endif %}
    </div>

    <div class="post-content">{{ post.content }}</div>

    <div class="d-flex align-items-center gap-2">
      <span class="text-muted">いいね {{ post.likes.count() }}</span>
      <span class="text-muted">コメント {{ post.comments.count() }}</span>
    </div>

    {% set comments_sorted = post.comments.all()|sort(attribute='timestamp') %}
    {% for c in comments_sorted %}
    <div class="comment">
      {% if c.session_id in session.get('user_comments', []) %}
      <strong>{{ current_user.username }}</strong>：{{ c.content }} {% else %}
      <strong>{{ c.get_display_name() }}</strong>：{{ c.content }} {% endif %}
      <span class="text-muted">（{{ c.timestamp|jst }}）</span>
    </div>
    {% endfor %}
  </div>
  {% endfor %} {% else %}
  <div class="alert alert-info">
    投稿がありません。最初の投稿をしてみましょう！
  </div>
  {% endif %}
</div>
{% endblock %} {% block scripts %}
<script>
  // チャンネル名から色を生成（任意の拡張チャンネル向け）
  function getChannelColor(channelName) {
    let hash = 0;
    for (let i = 0; i < channelName.length; i++) {
      hash = (hash << 5) - hash + channelName.charCodeAt(i);
      hash |= 0;
    }
    const hue = Math.abs(hash) % 360;
    const saturation = 65 + (Math.abs(hash) % 20);
    const lightness = 45 + (Math.abs(hash) % 15);
    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".channel-label").forEach((label) => {
      const channelName = label.dataset.channel;
      if (
        channelName &&
        !["general", "job", "class", "circle"].includes(channelName)
      ) {
        label.style.backgroundColor = getChannelColor(channelName);
      }
    });
  });
</script>
{% endblock %}
