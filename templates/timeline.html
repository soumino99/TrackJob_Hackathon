{% extends "base.html" %} {% block title %}ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - ConnectU{% endblock %}
{% block content %}
<div class="timeline-container">
  <h2>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>

  <div class="mb-3">
    <a
      href="{{ url_for('timeline') }}"
      class="btn btn-outline-primary {% if not selected_channel %}active{% endif %}"
      >å…¨ã¦</a
    >
    <a
      href="{{ url_for('timeline', channel='general') }}"
      class="btn btn-outline-primary channel-general {% if selected_channel == 'general' %}active{% endif %}"
      >ä¸€èˆ¬</a
    >
    <a
      href="{{ url_for('timeline', channel='job') }}"
      class="btn btn-outline-primary channel-job {% if selected_channel == 'job' %}active{% endif %}"
      >å°±æ´»</a
    >
    <a
      href="{{ url_for('timeline', channel='class') }}"
      class="btn btn-outline-primary channel-class {% if selected_channel == 'class' %}active{% endif %}"
      >æˆæ¥­</a
    >
    <a
      href="{{ url_for('timeline', channel='circle') }}"
      class="btn btn-outline-primary channel-circle {% if selected_channel == 'circle' %}active{% endif %}"
      >ã‚µãƒ¼ã‚¯ãƒ«</a
    >
  </div>

  <div class="mb-3">
    {% if selected_channel %}
    <a
      href="{{ url_for('post', channel=selected_channel) }}"
      class="btn btn-tweet"
      >æ–°è¦æŠ•ç¨¿</a
    >
    {% else %}
    <a href="{{ url_for('post') }}" class="btn btn-tweet">æ–°è¦æŠ•ç¨¿</a>
    {% endif %}
  </div>

  {% if posts %} {% for post in posts %}
  <div class="post-card">
    <div class="post-header">
      <span class="username">{{ post.get_display_name() }}</span>
      <span class="timestamp">{{ post.timestamp|jst }}</span>
      <span
        class="channel-label {{ post.channel }}"
        data-channel="{{ post.channel }}"
      >
        {{ post.channel|channel_jp }}
      </span>
      {% if post.author == current_user %}
      <div class="post-actions">
        <button
          class="btn-delete"
          onclick="deletePost({{ post.id }})"
          title="å‰Šé™¤"
        >
          <i class="delete-icon">ğŸ—‘ï¸</i>
        </button>
      </div>
      {% endif %}
    </div>

    <div class="post-content">{{ post.content }}</div>

    <!-- ã„ã„ã­ -->
    <div class="d-flex align-items-center gap-2">
      <form
        action="{{ url_for('like', post_id=post.id) }}"
        method="post"
        style="display: inline"
      >
        {% if current_user.is_authenticated and
        post.likes.filter_by(user_id=current_user.id).first() %}
        <button type="submit" class="btn btn-sm btn-outline-danger">
          â¤ï¸ {{ post.likes.count() }}
        </button>
        {% else %}
        <button type="submit" class="btn btn-sm btn-outline-secondary">
          ğŸ¤ {{ post.likes.count() }}
        </button>
        {% endif %}
      </form>
      <span class="text-muted">ã‚³ãƒ¡ãƒ³ãƒˆ {{ post.comments.count() }}</span>
    </div>

    <!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ -->
    <form
      action="{{ url_for('comment', post_id=post.id) }}"
      method="post"
      class="mt-2"
    >
      <div class="input-group">
        <input
          type="text"
          name="content"
          class="form-control"
          placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"
        />
        <button type="submit" class="btn btn-outline-primary">é€ä¿¡</button>
      </div>
    </form>

    <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ï¼ˆtimestampæ˜‡é †ï¼‰ -->
    {% set comments_sorted = post.comments.all()|sort(attribute='timestamp') %}
    {% for c in comments_sorted %}
    <div class="comment">
      <strong>{{ c.get_display_name() }}</strong>ï¼š{{ c.content }}
      <span class="text-muted">ï¼ˆ{{ c.timestamp|jst }}ï¼‰</span>
    </div>
    {% endfor %}
  </div>
  {% endfor %} {% else %}
  <div class="alert alert-info">
    æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¨¿ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
  </div>
  {% endif %}
</div>
{% endblock %} {% block scripts %}
<script>
  // ãƒãƒ£ãƒ³ãƒãƒ«åã‹ã‚‰è‰²ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
  function getChannelColor(channelName) {
    let hash = 0;
    for (let i = 0; i < channelName.length; i++) {
      const char = channelName.charCodeAt(i);
      hash = (hash << 5) - hash + char;
      hash = hash & hash;
    }
    const hue = Math.abs(hash) % 360;
    const saturation = 65 + (Math.abs(hash) % 20);
    const lightness = 45 + (Math.abs(hash) % 15);
    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
  }

  // ãƒãƒ£ãƒ³ãƒãƒ«ãƒ©ãƒ™ãƒ«ã«å‹•çš„è‰²ã‚’é©ç”¨
  document.addEventListener("DOMContentLoaded", function () {
    const channelLabels = document.querySelectorAll(".channel-label");
    channelLabels.forEach((label) => {
      const channelName = label.dataset.channel;
      if (
        channelName &&
        !["general", "job", "class", "circle"].includes(channelName)
      ) {
        const color = getChannelColor(channelName);
        label.style.backgroundColor = color;
      }
    });

    const channelButtons = document.querySelectorAll(
      '.btn-outline-primary[href*="channel="]'
    );
    channelButtons.forEach((button) => {
      const url = new URL(button.href);
      const channelName = url.searchParams.get("channel");
      if (
        channelName &&
        !["general", "job", "class", "circle"].includes(channelName)
      ) {
        const color = getChannelColor(channelName);
        button.style.color = color;
        button.style.borderColor = color;
        if (button.classList.contains("active")) {
          button.style.backgroundColor = color;
          button.style.borderColor = color;
          button.style.color = "white";
        }
        button.addEventListener("mouseenter", function () {
          if (!this.classList.contains("active")) {
            this.style.backgroundColor = color;
            this.style.color = "white";
          }
        });
        button.addEventListener("mouseleave", function () {
          if (!this.classList.contains("active")) {
            this.style.backgroundColor = "transparent";
            this.style.color = color;
          }
        });
      }
    });
  });

  // æŠ•ç¨¿å‰Šé™¤
  function deletePost(postId) {
    if (confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
      const form = document.createElement("form");
      form.method = "POST";
      form.action = `/delete_post/${postId}`;
      const csrfToken = document.querySelector('meta[name="csrf-token"]');
      if (csrfToken) {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "csrf_token";
        input.value = csrfToken.content;
        form.appendChild(input);
      }
      document.body.appendChild(form);
      form.submit();
    }
  }
</script>
{% endblock %}
